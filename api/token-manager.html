

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TokenManager &mdash; Evolution LangChain 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=95aa0e50" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=af2ce170"></script>
      <script src="../_static/doctools.js?v=888ff710"></script>
      <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="EvolutionInference" href="evolution-inference.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >

          
          
          <a href="../index.html" class="icon icon-home">
            Evolution LangChain
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">–£—Å—Ç–∞–Ω–æ–≤–∫–∞</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guide/basics.html">–û—Å–Ω–æ–≤—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guide/langchain-integration.html">–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å LangChain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guide/token-management.html">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞–º–∏</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guide/error-handling.html">–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">–ü—Ä–∏–º–µ—Ä—ã:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../examples/basic.html">–ë–∞–∑–æ–≤—ã–µ –ø—Ä–∏–º–µ—Ä—ã</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/chains.html">–ü—Ä–∏–º–µ—Ä—ã —Ü–µ–ø–æ—á–µ–∫</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/advanced.html">–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –ø—Ä–∏–º–µ—Ä—ã</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="evolution-inference.html">EvolutionInference</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">TokenManager</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id1">–û–±–∑–æ—Ä</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id2">–û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id3">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id4">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã</a></li>
<li class="toctree-l3"><a class="reference internal" href="#get-token">get_token()</a></li>
<li class="toctree-l3"><a class="reference internal" href="#refresh-token">_refresh_token()</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id6">–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –ª–æ–≥–∏–∫–∞</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id7">–ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª —Ç–æ–∫–µ–Ω–∞</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id8">–ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏</a></li>
<li class="toctree-l3"><a class="reference internal" href="#thread-safety">Thread-safety</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id9">–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#runtimeerror">RuntimeError</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id10">–¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id11">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id12">–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id13">–ú–µ—Ç—Ä–∏–∫–∏</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id14">–ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id15">–ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id16">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</a></li>
<li class="toctree-l3"><a class="reference internal" href="#retry">Retry –º–µ—Ö–∞–Ω–∏–∑–º</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id17">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id18">–ó–∞—â–∏—Ç–∞ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id19">–†–æ—Ç–∞—Ü–∏—è –∫–ª—é—á–µ–π</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id20">–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#evolutioninference">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ EvolutionInference</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id21">–ù–µ–∑–∞–≤–∏—Å–∏–º–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id22">–°–º. —Ç–∞–∫–∂–µ</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Evolution LangChain</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">TokenManager</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/cloud-ru-tech/evolution-langchain-python/blob/main/docs/api/token-manager.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="tokenmanager">
<h1>TokenManager<a class="headerlink" href="#tokenmanager" title="Permalink to this heading">ÔÉÅ</a></h1>
<section id="id1">
<h2>–û–±–∑–æ—Ä<a class="headerlink" href="#id1" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>–ö–ª–∞—Å—Å <code class="docutils literal notranslate"><span class="pre">TokenManager</span></code> —É–ø—Ä–∞–≤–ª—è–µ—Ç –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º —Ç–æ–∫–µ–Ω–æ–≤ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è Evolution Inference API. –û–±—ã—á–Ω–æ –≤–∞–º –Ω–µ –Ω—É–∂–Ω–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å —ç—Ç–∏–º –∫–ª–∞—Å—Å–æ–º –Ω–∞–ø—Ä—è–º—É—é, —Ç–∞–∫ –∫–∞–∫ <code class="docutils literal notranslate"><span class="pre">EvolutionInference</span></code> –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
</section>
<section id="id2">
<h2>–û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏<a class="headerlink" href="#id2" title="Permalink to this heading">ÔÉÅ</a></h2>
<ul class="simple">
<li><p>üîê <strong>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</strong>: –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –ø–æ key_id –∏ secret</p></li>
<li><p>üîÑ <strong>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</strong>: –¢–æ–∫–µ–Ω—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∑–∞ 30 —Å–µ–∫—É–Ω–¥ –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è</p></li>
<li><p>üíæ <strong>–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ</strong>: –¢–æ–∫–µ–Ω—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</p></li>
<li><p>üßµ <strong>Thread-safety</strong>: –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –≤ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–π —Å—Ä–µ–¥–µ</p></li>
<li><p>‚ö° <strong>–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è</strong>: –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é</p></li>
</ul>
</section>
<section id="id3">
<h2>–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è<a class="headerlink" href="#id3" title="Permalink to this heading">ÔÉÅ</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">evolution_langchain.evolution_inference</span><span class="w"> </span><span class="kn">import</span> <span class="n">TokenManager</span>

<span class="n">manager</span> <span class="o">=</span> <span class="n">TokenManager</span><span class="p">(</span>
    <span class="n">key_id</span><span class="o">=</span><span class="s2">&quot;your-key-id&quot;</span><span class="p">,</span>
    <span class="n">secret</span><span class="o">=</span><span class="s2">&quot;your-secret&quot;</span><span class="p">,</span>
    <span class="n">auth_url</span><span class="o">=</span><span class="s2">&quot;https://iam.api.cloud.ru/api/v1/auth/token&quot;</span>  <span class="c1"># –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ</span>
<span class="p">)</span>
</pre></div>
</div>
<section id="id4">
<h3>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã<a class="headerlink" href="#id4" title="Permalink to this heading">ÔÉÅ</a></h3>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>–ü–∞—Ä–∞–º–µ—Ç—Ä</p></th>
<th class="head"><p>–¢–∏–ø</p></th>
<th class="head"><p>–û–ø–∏—Å–∞–Ω–∏–µ</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">key_id</span></code></p></td>
<td><p>str</p></td>
<td><p>ID –∫–ª—é—á–∞ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">secret</span></code></p></td>
<td><p>str</p></td>
<td><p>–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á</p></td>
</tr>
<tr class="row-even"><td colspan="2"><p><code class="docutils literal notranslate"><span class="pre">auth_url</span></code> | str</p></td>
<td><p>URL —Å–µ—Ä–≤–µ—Ä–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id5">
<h3>–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã<a class="headerlink" href="#id5" title="Permalink to this heading">ÔÉÅ</a></h3>
</section>
<section id="get-token">
<h3>get_token()<a class="headerlink" href="#get-token" title="Permalink to this heading">ÔÉÅ</a></h3>
<p>–ü–æ–ª—É—á–∞–µ—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_token</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    –ü–æ–ª—É—á–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞.</span>

<span class="sd">    –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω, –µ—Å–ª–∏ –æ–Ω –∏—Å—Ç—ë–∫ –∏–ª–∏ –∏—Å—Ç–µ—á—ë—Ç –≤ –±–ª–∏–∂–∞–π—à–∏–µ 30 —Å–µ–∫—É–Ω–¥.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π access_token</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>
</div>
<p><strong>–ü—Ä–∏–º–µ—Ä:</strong>
.. code-block:: python</p>
<blockquote>
<div><p>manager = TokenManager(‚Äúkey_id‚Äù, ‚Äúsecret‚Äù)
token = manager.get_token()
print(f‚Äù–¢–æ–∫–µ–Ω: {token[:20]}‚Ä¶‚Äù)</p>
</div></blockquote>
</section>
<section id="refresh-token">
<h3>_refresh_token()<a class="headerlink" href="#refresh-token" title="Permalink to this heading">ÔÉÅ</a></h3>
<p>–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –º–µ—Ç–æ–¥ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞. –û–±—ã—á–Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">_refresh_token</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞.</span>

<span class="sd">    –í—ã–ø–æ–ª–Ω—è–µ—Ç HTTP –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ç–æ–∫–µ–Ω–∞.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: –ù–æ–≤—ã–π access_token</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: –ü—Ä–∏ –æ—à–∏–±–∫–µ HTTP –∑–∞–ø—Ä–æ—Å–∞ –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω–æ–º –æ—Ç–≤–µ—Ç–µ</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>
</div>
</section>
</section>
<section id="id6">
<h2>–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –ª–æ–≥–∏–∫–∞<a class="headerlink" href="#id6" title="Permalink to this heading">ÔÉÅ</a></h2>
<section id="id7">
<h3>–ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª —Ç–æ–∫–µ–Ω–∞<a class="headerlink" href="#id7" title="Permalink to this heading">ÔÉÅ</a></h3>
<ol class="arabic simple">
<li><p><strong>–ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å</strong>: –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–∑–æ–≤–µ <code class="docutils literal notranslate"><span class="pre">get_token()</span></code> –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</p></li>
<li><p><strong>–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ</strong>: –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ —Å –≤—Ä–µ–º–µ–Ω–µ–º –∏—Å—Ç–µ—á–µ–Ω–∏—è</p></li>
<li><p><strong>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–æ–∫–∞</strong>: –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–∞</p></li>
<li><p><strong>–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</strong>: –¢–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∑–∞ 30 —Å–µ–∫—É–Ω–¥ –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è</p></li>
<li><p><strong>Thread-safety</strong>: –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</p></li>
</ol>
</section>
<section id="id8">
<h3>–ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏<a class="headerlink" href="#id8" title="Permalink to this heading">ÔÉÅ</a></h3>
<p>–¢–æ–∫–µ–Ω —Å—á–∏—Ç–∞–µ—Ç—Å—è –∏—Å—Ç—ë–∫—à–∏–º –∑–∞ 30 —Å–µ–∫—É–Ω–¥ –¥–æ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">REFRESH_BUFFER_SECONDS</span> <span class="o">=</span> <span class="mi">30</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_is_token_expired</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">current_time</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_token_expires_at</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">REFRESH_BUFFER_SECONDS</span><span class="p">)</span>
</pre></div>
</div>
<p>–≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ –∏–∑-–∑–∞ –∏—Å—Ç—ë–∫—à–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤
- –ë–µ—Å–ø–µ—Ä–µ–±–æ–π–Ω—É—é —Ä–∞–±–æ—Ç—É API
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—É—é –∑–∞–¥–µ—Ä–∂–∫—É –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–∞—Ö</p>
</section>
<section id="thread-safety">
<h3>Thread-safety<a class="headerlink" href="#thread-safety" title="Permalink to this heading">ÔÉÅ</a></h3>
<p>–ö–ª–∞—Å—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è race conditions:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TokenManager</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
        <span class="c1"># ...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_token</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_token_expired</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_token</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token</span>
</pre></div>
</div>
</section>
</section>
<section id="id9">
<h2>–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫<a class="headerlink" href="#id9" title="Permalink to this heading">ÔÉÅ</a></h2>
<section id="runtimeerror">
<h3>RuntimeError<a class="headerlink" href="#runtimeerror" title="Permalink to this heading">ÔÉÅ</a></h3>
<p>–í–æ–∑–Ω–∏–∫–∞–µ—Ç –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:</span>
    <span class="c1"># - –ù–µ–≤–µ—Ä–Ω—ã–µ key_id/secret</span>
    <span class="c1"># - –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é</span>
    <span class="c1"># - –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</span>
</pre></div>
</div>
</section>
<section id="id10">
<h3>–¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏<a class="headerlink" href="#id10" title="Permalink to this heading">ÔÉÅ</a></h3>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>–û—à–∏–±–∫–∞</p></th>
<th class="head"><p>–ü—Ä–∏—á–∏–Ω–∞</p></th>
<th class="head"><p>–†–µ—à–µ–Ω–∏–µ</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">HTTP</span> <span class="pre">401</span></code></p></td>
<td><p>–ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ
–¥–∞–Ω–Ω—ã–µ</p></td>
<td><p>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å key_id –∏ secret</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">HTTP</span> <span class="pre">403</span></code></p></td>
<td><p>–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–∞–≤
–¥–æ—Å—Ç—É–ø–∞</p></td>
<td><p>–û–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Connection</span>
<span class="pre">timeout</span></code></p></td>
<td><p>–ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é</p></td>
<td><p>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">Invalid</span>
<span class="pre">response</span> <span class="pre">format</span></code></p></td>
<td><p>–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
—Å–µ—Ä–≤–µ—Ä–∞</p></td>
<td><p>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å auth_url</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="id11">
<h2>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥<a class="headerlink" href="#id11" title="Permalink to this heading">ÔÉÅ</a></h2>
<section id="id12">
<h3>–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ<a class="headerlink" href="#id12" title="Permalink to this heading">ÔÉÅ</a></h3>
<p>–î–ª—è –æ—Ç–ª–∞–¥–∫–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DebuggingTokenManager</span><span class="p">(</span><span class="n">TokenManager</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_token</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;–ó–∞–ø—Ä–æ—Å —Ç–æ–∫–µ–Ω–∞&quot;</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;–ü–æ–ª—É—á–µ–Ω —Ç–æ–∫–µ–Ω: </span><span class="si">{</span><span class="n">token</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">token</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_refresh_token</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">token</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_refresh_token</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;–¢–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">token</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
</pre></div>
</div>
</section>
<section id="id13">
<h3>–ú–µ—Ç—Ä–∏–∫–∏<a class="headerlink" href="#id13" title="Permalink to this heading">ÔÉÅ</a></h3>
<p>–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TokenMetrics</span><span class="p">:</span>
    <span class="n">refresh_time</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">token_lifetime</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">success</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">error</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MetricsTokenManager</span><span class="p">(</span><span class="n">TokenManager</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">TokenMetrics</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_refresh_token</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">token</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_refresh_token</span><span class="p">()</span>
            <span class="n">refresh_duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

            <span class="c1"># –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –∂–∏–∑–Ω–∏ —Ç–æ–∫–µ–Ω–∞ (–æ–±—ã—á–Ω–æ 3 –º–∏–Ω—É—Ç—ã = 180 —Å–µ–∫—É–Ω–¥)</span>
            <span class="n">token_lifetime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token_expires_at</span> <span class="o">-</span> <span class="n">start_time</span>

            <span class="n">metric</span> <span class="o">=</span> <span class="n">TokenMetrics</span><span class="p">(</span>
                <span class="n">refresh_time</span><span class="o">=</span><span class="n">refresh_duration</span><span class="p">,</span>
                <span class="n">token_lifetime</span><span class="o">=</span><span class="n">token_lifetime</span><span class="p">,</span>
                <span class="n">success</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">token</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">refresh_duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">TokenMetrics</span><span class="p">(</span>
                <span class="n">refresh_time</span><span class="o">=</span><span class="n">refresh_duration</span><span class="p">,</span>
                <span class="n">token_lifetime</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö&quot;</span>

        <span class="n">successful</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">success</span><span class="p">]</span>
        <span class="n">failed</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="o">.</span><span class="n">success</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">successful</span><span class="p">:</span>
            <span class="n">avg_refresh_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">refresh_time</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">successful</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">successful</span><span class="p">)</span>
            <span class="n">avg_lifetime</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">token_lifetime</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">successful</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">successful</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">avg_refresh_time</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">avg_lifetime</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;total_refreshes&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">),</span>
            <span class="s2">&quot;successful_refreshes&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">successful</span><span class="p">),</span>
            <span class="s2">&quot;failed_refreshes&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">failed</span><span class="p">),</span>
            <span class="s2">&quot;success_rate&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">successful</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s2">&quot;avg_refresh_time&quot;</span><span class="p">:</span> <span class="n">avg_refresh_time</span><span class="p">,</span>
            <span class="s2">&quot;avg_token_lifetime&quot;</span><span class="p">:</span> <span class="n">avg_lifetime</span>
        <span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="id14">
<h2>–ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è<a class="headerlink" href="#id14" title="Permalink to this heading">ÔÉÅ</a></h2>
<section id="id15">
<h3>–ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏<a class="headerlink" href="#id15" title="Permalink to this heading">ÔÉÅ</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CustomTokenManager</span><span class="p">(</span><span class="n">TokenManager</span><span class="p">):</span>
    <span class="n">REFRESH_BUFFER_SECONDS</span> <span class="o">=</span> <span class="mi">60</span>  <span class="c1"># –û–±–Ω–æ–≤–ª—è—Ç—å –∑–∞ –º–∏–Ω—É—Ç—É –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_is_token_expired</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">current_time</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_token_expires_at</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">REFRESH_BUFFER_SECONDS</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id16">
<h3>–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏<a class="headerlink" href="#id16" title="Permalink to this heading">ÔÉÅ</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">manager</span> <span class="o">=</span> <span class="n">TokenManager</span><span class="p">(</span>
    <span class="n">key_id</span><span class="o">=</span><span class="s2">&quot;your-key-id&quot;</span><span class="p">,</span>
    <span class="n">secret</span><span class="o">=</span><span class="s2">&quot;your-secret&quot;</span><span class="p">,</span>
    <span class="n">auth_url</span><span class="o">=</span><span class="s2">&quot;https://custom-auth-server.com/api/v2/token&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="retry">
<h3>Retry –º–µ—Ö–∞–Ω–∏–∑–º<a class="headerlink" href="#retry" title="Permalink to this heading">ÔÉÅ</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>

<span class="k">class</span><span class="w"> </span><span class="nc">RetryTokenManager</span><span class="p">(</span><span class="n">TokenManager</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_refresh_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_refresh_token</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attempt</span> <span class="o">==</span> <span class="n">max_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span>

                <span class="c1"># –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —Å jitter</span>
                <span class="n">delay</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">attempt</span><span class="p">)</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;–ü–æ–≤—Ç–æ—Ä –ø–æ–ø—ã—Ç–∫–∏ </span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> —á–µ—Ä–µ–∑ </span><span class="si">{</span><span class="n">delay</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">—Å&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="id17">
<h2>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å<a class="headerlink" href="#id17" title="Permalink to this heading">ÔÉÅ</a></h2>
<section id="id18">
<h3>–ó–∞—â–∏—Ç–∞ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö<a class="headerlink" href="#id18" title="Permalink to this heading">ÔÉÅ</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.fernet</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fernet</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SecureTokenManager</span><span class="p">(</span><span class="n">TokenManager</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encrypted_key_id</span><span class="p">,</span> <span class="n">encrypted_secret</span><span class="p">,</span> <span class="n">encryption_key</span><span class="p">):</span>
        <span class="c1"># –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">Fernet</span><span class="p">(</span><span class="n">encryption_key</span><span class="p">)</span>
        <span class="n">key_id</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">encrypted_key_id</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="n">secret</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">encrypted_secret</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">key_id</span><span class="p">,</span> <span class="n">secret</span><span class="p">)</span>

        <span class="c1"># –û—á–∏—Å—Ç–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–∑ –ø–∞–º—è—Ç–∏</span>
        <span class="k">del</span> <span class="n">key_id</span><span class="p">,</span> <span class="n">secret</span>
</pre></div>
</div>
</section>
<section id="id19">
<h3>–†–æ—Ç–∞—Ü–∏—è –∫–ª—é—á–µ–π<a class="headerlink" href="#id19" title="Permalink to this heading">ÔÉÅ</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">RotatingTokenManager</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">primary_manager</span><span class="p">,</span> <span class="n">backup_manager</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary</span> <span class="o">=</span> <span class="n">primary_manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backup</span> <span class="o">=</span> <span class="n">backup_manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_backup</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_token</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_backup</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">backup</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="c1"># –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_backup</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_backup</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_backup</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">backup</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<section id="id20">
<h2>–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è<a class="headerlink" href="#id20" title="Permalink to this heading">ÔÉÅ</a></h2>
<section id="evolutioninference">
<h3>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ EvolutionInference<a class="headerlink" href="#evolutioninference" title="Permalink to this heading">ÔÉÅ</a></h3>
<p>TokenManager –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ EvolutionInference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># –í–Ω—É—Ç—Ä–∏ EvolutionInference</span>
<span class="k">class</span><span class="w"> </span><span class="nc">EvolutionInference</span><span class="p">(</span><span class="n">BaseLLM</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_id</span><span class="p">,</span> <span class="n">secret</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_token_manager</span> <span class="o">=</span> <span class="n">TokenManager</span><span class="p">(</span><span class="n">key_id</span><span class="p">,</span> <span class="n">secret</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token_manager</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
        <span class="c1"># ... –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞</span>
</pre></div>
</div>
</section>
<section id="id21">
<h3>–ù–µ–∑–∞–≤–∏—Å–∏–º–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ<a class="headerlink" href="#id21" title="Permalink to this heading">ÔÉÅ</a></h3>
<p>–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å TokenManager –æ—Ç–¥–µ–ª—å–Ω–æ:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

<span class="n">manager</span> <span class="o">=</span> <span class="n">TokenManager</span><span class="p">(</span><span class="s2">&quot;key_id&quot;</span><span class="p">,</span> <span class="s2">&quot;secret&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">make_api_request</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s2">&quot;https://api.cloud-ru-tech.com/v1/chat/completions&quot;</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">},</span>
        <span class="n">json</span><span class="o">=</span><span class="n">data</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<section id="id22">
<h2>–°–º. —Ç–∞–∫–∂–µ<a class="headerlink" href="#id22" title="Permalink to this heading">ÔÉÅ</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="evolution-inference.html"><span class="doc">EvolutionInference</span></a> - –û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å LLM</p></li>
<li><p><a class="reference internal" href="../guide/token-management.html"><span class="doc">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞–º–∏</span></a> - –ü–æ–¥—Ä–æ–±–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ</p></li>
<li><p><a class="reference internal" href="../guide/error-handling.html"><span class="doc">–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫</span></a> - –†–∞–±–æ—Ç–∞ —Å –æ—à–∏–±–∫–∞–º–∏</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="evolution-inference.html" class="btn btn-neutral float-left" title="EvolutionInference" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Evolution ML Inference Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>